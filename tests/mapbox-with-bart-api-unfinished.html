<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8' />
  <title>Prototype v1</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.js'></script>
  <link rel="stylesheet" href="https://unpkg.com/tachyons@4.10.0/css/tachyons.min.css"/>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.css' rel='stylesheet' />
  <style>
    body {
      background-color: #343332;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
    form {
      z-index: 10;
    }
    #trips {
      right: 20px;
      bottom: 20px;
    }
  </style>
</head>

<body class="ma0 pa0 sans-serif">
  <form class="absolute bg-white flex items-center justify-around pv1 ph3 text-center w-100">
    <select name="pointA" id="pointA" class="f6 ml2">
      <option disabled selected>Point A</option>
    </select>
    <div class="ph2">to</div>
    <select name="pointB" id="pointB" class="f6 mr2">
      <option disabled selected>Point B</option>
    </select>
    <div class="ml-auto pr3">
      <input type="text" name="tripName" placeholder="Trip Label" required class="f6">
      <button type="submit" class="ba bw0 input-reset pointer f6 link dim br-pill pv1 ph4 dib white bg-dark-blue">Add Trip</button>
    </div>
  </form>

  <div id='map'></div>

  <table id="trips" class="fixed pa3 bg-white black ba bw1">
    <thead>
      <tr>
        <th>Point A</th>
        <th>Point B</th>
        <th>Line</th>
        <th>Next Train</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td class="pa2 tc">Point A</td>
        <td class="pa2 tc">Point B</td>
        <td class="pa2 tc">Orange</td>
        <td class="pa2 tc">11:57am</td>
        <td class="pa2 tc"><a href="#" class="link mr1">✏️</a> <a href="#" class="link">❌</a> </td>
      </tr>
      <tr>
        <td class="pa2 tc">Point A</td>
        <td class="pa2 tc">Point B</td>
        <td class="pa2 tc">Orange</td>
        <td class="pa2 tc">11:57am</td>
        <td class="pa2 tc"><a href="#" class="link mr1">✏️</a> <a href="#" class="link">❌</a> </td>
      </tr>
      <tr>
        <td class="pa2 tc">Point A</td>
        <td class="pa2 tc">Point B</td>
        <td class="pa2 tc">Orange</td>
        <td class="pa2 tc">11:57am</td>
        <td class="pa2 tc"><a href="#" class="link mr1">✏️</a> <a href="#" class="link">❌</a> </td>
      </tr>
    </tbody>
  </table>

  <script>
    const API_KEY = "MW9S-E7SL-26DU-VV8V";
    const queryURL = `https://api.bart.gov/api/stn.aspx?cmd=stns&key=${API_KEY}&json=y`;
    let points = [];
    // Fetching the API.
    fetch(queryURL)
      .then(result => result.json())
      .then(response => {
        let stations = response.root.stations.station;
        // Uncomment next line to preview "stations" as a response
        // console.log(stations)
        let targetA = document.querySelector("#pointA");
        let targetB = document.querySelector("#pointB");
        stations.forEach(station => {
          // For Mapbox API, lng first, then lat
          let template = `<option data-mapbox-lng="${station.gtfs_longitude}" data-mapbox-lat="${station.gtfs_latitude}" value="${station.name}">${station.name}</option>`;
          targetA.innerHTML += template;
          targetB.innerHTML += template;
        });
      });
    // Targets the select dropdown.
    const selectGroups = document.querySelectorAll("select");
    selectGroups.forEach(select => {
      select.addEventListener("change", (event) => {
        var lng = event.target.options[event.target.selectedIndex].getAttribute("data-mapbox-lng");
        var lat = event.target.options[event.target.selectedIndex].getAttribute("data-mapbox-lat");
        points.push([parseFloat(lng), parseFloat(lat)]);
        if (points.length === 2) {
          drawMap(points);
        }
      });
    });
    const drawMap = (points) => {
      var geojson = {
        "type": "FeatureCollection",
        "features": [{
          "type": "Feature",
          "geometry": {
            "type": "LineString",
            "properties": {},
            "coordinates": points
          }
        }]
      };
      // Mapbox
      mapboxgl.accessToken = 'pk.eyJ1IjoiZHJ1a2VsbHkiLCJhIjoiY2p1ZGpsYzd1MDgyNTQ0bXRqbW5rbXk1dCJ9.IOyAszC7bL2GBhSRgCdAVQ';
      // A GeoJSON object with a LineString route from the ___ to ___
      var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/dark-v9',
        center: [-122.056012, 37.928468],
        zoom: 12
      });
      map.on('load', function () {
        map.addLayer({
          "id": "LineString",
          "type": "line",
          "source": {
            "type": "geojson",
            "data": geojson
          },
          "layout": {
            "line-join": "round",
            "line-cap": "round"
          },
          "paint": {
            "line-color": "#FFD700",
            "line-width": 5
          }
        });
        // Geographic coordinates of the LineString
        let coordinates = geojson.features[0].geometry.coordinates;
        // Pass the first coordinates in the LineString to `lngLatBounds` &
        // wrap each coordinate pair in `extend` to include them in the bounds
        // result. A variation of this technique could be applied to zooming
        // to the bounds of multiple Points or Polygon geomteries - it just
        // requires wrapping all the coordinates with the extend method.
        let bounds = coordinates.reduce(function (bounds, coord) {
          return bounds.extend(coord);
        }, new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]));
        map.fitBounds(bounds, {
          padding: 100
        });
      });
    }
    // TODO
    // https://stackoverflow.com/questions/26635880/remove-polylines-on-a-map-from-mapbox
  </script>

</body>

</html>